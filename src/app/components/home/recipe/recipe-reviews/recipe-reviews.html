<div class="backdrop" (click)="onCancel()"></div>
<dialog open>
    <div class="reviews-header">
        <div class="header-info">
            <h2 class="reviews-title">Recipe Reviews</h2>
            <div class="reviews-subtitle">What others are saying</div>
        </div>
        <button class="close-button" (click)="onCancel()" title="Close">
            √ó
        </button>
    </div>

    @if (isAddingReview()) {
        <app-add-review
        (cancelReview)="onCancelReview()"
        (onNewReview)="handleNewReview($event)"
        [recipeId]="recipe()!.id"
        >

        </app-add-review>
    }
    @else {
    @if (currentReviews().length === 0) {
        @if (!isUserAuthor() && this.currentUserId()) {
            <div class="add-review-section">
        <button class="add-review-btn" (click)="onAddReview()" title="Add your review">
            <span class="add-review-icon">+</span>
            <span class="add-review-text">Add Review</span>
         </button>
    </div>
        }
    <div class="no-reviews">
            <div class="no-reviews-icon">üìù</div>
            <h3 class="no-reviews-title">No reviews yet</h3>
            <p class="no-reviews-message">
                This recipe still waits for first review!
            </p>
    </div>
    }
    
    @else {
        <div class="reviews-stats">
            <div class="stat-item">
                <div class="stat-value">{{ reviews().length }}</div>
                <div class="stat-label">Reviews</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ getAverageRating() }}</div>
                <div class="stat-label">Avg Rating</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ getMostCommonRating() }}</div>
                <div class="stat-label">Most Common</div>
            </div>
            @if (!isUserAuthor()) {
                @if (canAddReview() && this.currentUserId()) {
                <button class="add-review-btn" (click)="onAddReview()">
                    <span class="add-review-icon">+</span>
                    <span class="add-review-text">Add Review</span>
                </button>
            }
            @else {
                @if (this.currentUserId()) {
                <button class="delete-review-btn" (click)="onDeleteReview()">
                    <span class="add-review-icon">√ó</span>
                    <span class="add-review-text">Delete Review</span>
                </button>
                } 
            }
        }
        </div>

        <div class="reviews-content">
            <div class="reviews-list">
                @for (review of currentReviews(); track review.id) {
                    <div class="review-item">
                        <div class="review-header">
                            <div class="review-author">
                                <h3 class="author-name">{{ review.author.fullname }}</h3>
                                <div class="author-username">@{{ review.author.username }}</div>
                            </div>
                            <div class="review-rating">
                                <div class="rating-stars">
                                    @for (star of getRatingStars(review.rating); track $index) {
                                        <span class="star" [class.empty]="!star">‚òÖ</span>
                                    }
                                </div>
                                <div class="rating-value">{{ review.rating }}/10</div>
                            </div>
                        </div>
                        <h4 class="review-title">{{ review.title }}</h4>
                        <p class="review-content">{{ review.reviewContent }}</p>
                    </div>
                }
            </div>
        </div>
    }
    }
</dialog>